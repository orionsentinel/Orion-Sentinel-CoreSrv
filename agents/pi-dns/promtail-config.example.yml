# Promtail Configuration for Pi 5 #1 (DNS Pi)
# Ship Docker container logs from DNS stack to CoreSrv Loki
#
# This configuration should be deployed on Pi 5 #1 (DNS Pi) which runs:
#   - Pi-hole (DNS filtering & ad blocking)
#   - Unbound (recursive DNS resolver)
#   - Keepalived (HA VIP)
#
# All logs will be shipped to the central Loki instance on CoreSrv

# ============================================================================
# DEPLOYMENT INSTRUCTIONS
# ============================================================================
# 1. Copy this file to Pi 5 #1: /opt/promtail/config.yml
# 2. Replace CORESRV_LAN_IP below with your CoreSrv's LAN IP (e.g., 192.168.1.100)
# 3. Ensure CoreSrv Loki port 3100 is published and accessible from this Pi
# 4. Deploy Promtail container (see docker run example below)
#
# Example docker command on Pi 5 #1:
#
# docker run -d --name promtail \
#   --restart unless-stopped \
#   -v /var/lib/docker/containers:/var/lib/docker/containers:ro \
#   -v /var/run/docker.sock:/var/run/docker.sock:ro \
#   -v /opt/promtail/config.yml:/etc/promtail/config.yml:ro \
#   grafana/promtail:2.9.5 \
#   -config.file=/etc/promtail/config.yml
#
# Or using docker-compose:
#
# services:
#   promtail:
#     image: grafana/promtail:2.9.5
#     container_name: promtail
#     restart: unless-stopped
#     command: -config.file=/etc/promtail/config.yml
#     volumes:
#       - /var/lib/docker/containers:/var/lib/docker/containers:ro
#       - /var/run/docker.sock:/var/run/docker.sock:ro
#       - /opt/promtail/config.yml:/etc/promtail/config.yml:ro

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================
server:
  http_listen_port: 9080
  grpc_listen_port: 0

# ============================================================================
# POSITIONS (log tailing state)
# ============================================================================
positions:
  filename: /tmp/positions.yml

# ============================================================================
# LOKI CLIENT (CoreSrv)
# ============================================================================
clients:
  - url: http://CORESRV_LAN_IP:3100/loki/api/v1/push
    # ☝️ REPLACE CORESRV_LAN_IP with your CoreSrv's actual LAN IP
    # Example: http://192.168.1.100:3100/loki/api/v1/push
    
    # Optional: Basic auth if you secure Loki
    # basic_auth:
    #   username: promtail
    #   password: your-password-here
    
    # Optional: Backoff and retry settings
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    
    # Optional: Limit sending rate
    # tenant_id: pi-dns

# ============================================================================
# SCRAPE CONFIGURATIONS
# ============================================================================
scrape_configs:
  # Docker containers on Pi 5 #1 (DNS Pi)
  - job_name: pi-dns-docker
    static_configs:
      - targets:
          - localhost
        labels:
          job: pi-dns-docker
          host: pi-dns
          node: pi-dns
          stack: dns-ha
          role: dns-server
          environment: production
          __path__: /var/lib/docker/containers/*/*-json.log
    
    # Pipeline stages to parse Docker JSON logs
    pipeline_stages:
      # Parse Docker JSON log format
      - docker: {}
      
      # Optional: Extract log level from log content
      # - regex:
      #     expression: '^(?P<level>(DEBUG|INFO|WARN|ERROR|FATAL))'
      # - labels:
      #     level:
      
      # Optional: Drop noisy logs
      # - match:
      #     selector: '{job="pi-dns-docker"} |~ "healthcheck"'
      #     action: drop

  # Optional: Scrape system logs (syslog, auth.log, etc.)
  # Uncomment if you want to ship Pi system logs too
  # - job_name: pi-dns-system
  #   static_configs:
  #     - targets:
  #         - localhost
  #       labels:
  #         job: pi-dns-system
  #         host: pi-dns
  #         stack: dns-ha
  #         __path__: /var/log/*.log
  #   
  #   pipeline_stages:
  #     - regex:
  #         expression: '^(?P<timestamp>\w+\s+\d+\s+\d+:\d+:\d+)\s+(?P<hostname>\S+)\s+(?P<process>\S+?)(\[(?P<pid>\d+)\])?:\s+(?P<message>.*)$'
  #     - labels:
  #         hostname:
  #         process:
  #     - timestamp:
  #         source: timestamp
  #         format: 'Jan _2 15:04:05'

# ============================================================================
# NOTES
# ============================================================================
# - This Promtail instance must have read access to /var/lib/docker/containers
# - All logs are labeled with host=pi-dns, stack=dns-ha
# - In Grafana, filter logs with: {host="pi-dns"}
# - Container-specific logs: {host="pi-dns", container_name="pihole"}
#
# Troubleshooting:
# - Check Promtail logs: docker logs promtail
# - Verify Loki connectivity: curl http://CORESRV_LAN_IP:3100/ready
# - Test log ingestion: docker logs <some-container> (should appear in Grafana)
