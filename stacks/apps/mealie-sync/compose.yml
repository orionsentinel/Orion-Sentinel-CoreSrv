# Orion-Sentinel-CoreSrv Mealie Recipe Sync
# Automated recipe importing from RSS feeds, URL lists, and sitemaps
#
# Usage:
#   ./scripts/orionctl up apps --profile food_sync
#
# Configuration:
#   - Edit config/sources.yaml to add recipe sources
#   - Edit config/settings.yaml for general settings
#   - Set MEALIE_API_TOKEN environment variable

services:
  ############################
  # MEALIE RECIPE SYNC
  ############################

  mealie-sync:
    build:
      context: ./app
      dockerfile: Dockerfile
    image: orion/mealie-sync:latest
    container_name: orion_mealie_sync
    restart: unless-stopped
    profiles:
      - food_sync
    environment:
      - TZ=${TZ:-Europe/Amsterdam}
      # Mealie API configuration
      - MEALIE_BASE_URL=${MEALIE_BASE_URL:-http://mealie:9000}
      - MEALIE_API_TOKEN=${MEALIE_API_TOKEN}
      # Sync configuration
      - SYNC_INTERVAL_MINUTES=${SYNC_INTERVAL_MINUTES:-1440}
      - MAX_NEW_RECIPES_PER_RUN=${MAX_NEW_RECIPES_PER_RUN:-10}
      # Network configuration
      - REQUEST_TIMEOUT_SECONDS=${REQUEST_TIMEOUT_SECONDS:-30}
      - RATE_LIMIT_SECONDS_PER_DOMAIN=${RATE_LIMIT_SECONDS_PER_DOMAIN:-2.0}
      - USER_AGENT=${USER_AGENT:-Mozilla/5.0 (compatible; MealieRecipeSync/1.0)}
      # Operational settings
      - DRY_RUN=${DRY_RUN:-false}
      - JSON_LOGS=${JSON_LOGS:-false}
    volumes:
      # Configuration files (recipe_sources.yaml or sources.yaml)
      - ./config:/config:ro
      # State persistence (SQLite database)
      - ${ORION_INTERNAL_ROOT:-/srv/orion/internal}/appdata/mealie-sync/data:/data
    networks:
      - orion_apps
    security_opt:
      - no-new-privileges:true
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

############################
# NETWORKS
############################

networks:
  orion_apps:
    name: orion_apps
    external: true
